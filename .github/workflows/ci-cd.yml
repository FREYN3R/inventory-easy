name: CI/CD Pipeline - InventoryEasy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies - Products Service
        run: |
          cd backend/products-service
          npm ci

      - name: Install dependencies - Stock Service
        run: |
          cd backend/stock-service
          npm ci

      - name: Install dependencies - Suppliers Service
        run: |
          cd backend/suppliers-service
          npm ci

      - name: Install dependencies - Frontend
        run: |
          cd frontend
          npm ci

      - name: Build Frontend
        run: |
          cd frontend
          npm run build

  build-and-push:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Products Service
        run: |
          docker build -t inventory-products-service:${{ github.sha }} ./backend/products-service

      - name: Build Stock Service
        run: |
          docker build -t inventory-stock-service:${{ github.sha }} ./backend/stock-service

      - name: Build Suppliers Service
        run: |
          docker build -t inventory-suppliers-service:${{ github.sha }} ./backend/suppliers-service

      - name: Build Frontend
        run: |
          docker build -t inventory-frontend:${{ github.sha }} ./frontend

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start services with Docker Compose
        run: |
          docker-compose up -d
          sleep 30

      - name: Health check - Products Service
        run: |
          curl -f http://localhost:3001/health || exit 1

      - name: Health check - Stock Service
        run: |
          curl -f http://localhost:3002/health || exit 1

      - name: Health check - Suppliers Service
        run: |
          curl -f http://localhost:3003/health || exit 1

      - name: Install k6
        run: |
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 load tests
        run: |
          k6 run tests/k6/load-test.js
        continue-on-error: true

      - name: Stop services
        run: docker-compose down

  deploy:
    name: Deploy Notification
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    